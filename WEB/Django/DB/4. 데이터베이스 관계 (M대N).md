# 데이터베이스 관계 (M : N)

### 1:N (one to many)

#### 준비

> `onetomany`  app 생성

```python
# models.py
class User(models.Model):
    username = models.CharField(max_length=10)
    
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    user = models.ForeignKey(User, on_delete=models.CASCADE)

class Comment(models.Model):
    content = models.TextField()
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
```



```python
from onetomany.models import User, Article, Comment

# objects
u1 = User.objects.create(username='Kim')
u2 = User.objects.create(username='Lee')

a1 = Article.objects.create(title='1글', user=u1)
a2 = Article.objects.create(title='2글', user=u2)
a3 = Article.objects.create(title='3글', user=u2)
a4 = Article.objects.create(title='4글', user=u2)

c1 = Comment.objects.create(content='1글1댓', article=a1, user=u2)
c2 = Comment.objects.create(content='1글2댓', article=a1, user=u2)
c3 = Comment.objects.create(content='2글1댓', article=a2, user=u1)
c4 = Comment.objects.create(content='4글1댓', article=a4, user=u1)
c5 = Comment.objects.create(content='3글1댓', article=a3, user=u2)
c6 = Comment.objects.create(content='3글2댓', article=a3, user=u1)
```

#### 문제

1. 1번 유저가 작성한 글들

   ```python
   u1.article_set.all()
   ```

2. 2번 유저가 작성한 댓글의 내용을 모두 출력

   ```python
   for comment in u2.comment_set.all():
       print(comment.content)
   ```

3. 3번 글의 작성된 댓글의 내용을 모두 출력

   ```python
   for comment in a3.comment_set.all():
       print(comment.content)
   ```

   ```html
   {% for comment in article.comment_set.all %}
      {{ comment.content }}
   {% endfor %}
   ```

4. 1글이라는 제목인 게시글들

   ```python
   Article.objects.filter(title='1글')
   ```

5. 글이라는 단어가 들어간 게시글들

   ```python
   Article.objects.filter(title__contains='글')
   ```

6. 댓글(N)들 중에 해당되는 글(1)의 제목이 1글인 것

   ```python
   Comment.objects.filter(article__title='1글')
   print(Comment.objects.filter(article__title='1글').query)
   ```

   * 1:N 관계에서 1의 열에 따라서,  필터링

     ```sql
     SELECT "onetomany_comment"."id", "onetomany_comment"."content", "onetomany_comment"."article_id", "onetomany_comment"."user_id" FROM "onetomany_comment" INNER JOIN "onetomany_article" ON ("onetomany_comment"."article_id" = "onetomany_article"."id") WHERE "onetomany_article"."title" = 1글
     ```

### 2. M:N (Many to Many)


#### 단순 모델링

```python
class Doctor(models.Model):
    name = models.CharField(max_length=10)

class Patient(models.Model):
    name = models.CharField(max_length=10)

class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
```

* 환자/의사 생성

  ```python
  d1 = Doctor.objects.create(name='dr.a')
  d2 = Doctor.objects.create(name='dr.b')
  
  p1 = Patient.objects.create(name='a')
  p2 = Patient.objects.create(name='b')
  ```

* 예약 만들기

  ```python
  Reservation.objects.create(doctor=d1, patient=p1)
  Reservation.objects.create(doctor=d1, patient=p2)
  Reservation.objects.create(doctor=d2, patient=p1)
  ```

* 1번 의사의 예약 목록

  ```python
  d1.reservation_set.all()
  ```

  ```python
  # 같은 동작하는 코드
  Resrevation.objects.filter(doctor_id=1)
  ```

* 1번 환자의 예약 목록

  ```python
  p1.reservation_set.all()
  ```

  ```python
  p1 = Reservation.objects.get(pk=1)
  
  Reservation.objects.get(patiend=p1, doctor=d3)
  #= Reservation.objects.filter(patient=p1, doctor=d3)[0]
  # filter는 queryset을 반환하기 때문에
  ```

* 1번 의사의 환자 출력

  ```python
  for reservation in d1.reservation_set.all():
      print(reservation.patient.name)
  ```

#### 중개 모델 활용

> 의사 - 환자들 / 환자 - 의사들로 직접 접근하기 위해서는 `ManyToManyField`를 사용한다.
>
> `through`  옵션을 통해 중개 모델을 선언한다.

```python
class Doctor(models.Model):
    name = models.CharField(max_length=10)

class Patient(models.Model):
    name = models.CharField(max_length=10)
    # M:N 필드! reservation 통해서, Doctor에 접근을 의미
    # DB X, ORM에서 메서드 조작을 편하게 하기 위한 것!!
    doctors = models.ManyToManyField(Doctor, 
                                    through='Reservation')

class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
```

* 마이그레이션 파일을 만들거나, migrate를 할 필요가 없다.

  * 즉, 데이터베이스에 전혀 변경되는 것은 없고, ORM 조작에서의 차이만 존재한다.

* 의사, 환자 오브젝트 가져오기

  ```python
  p1 = Patient.objects.get(pk=1)
  d1 = Doctor.objects.get(pk=1)
  ```

* 1번 환자의 의사 목록

  > `ManyToManyField` 가 정의된 `Patient` 는 직접 참조

  ```python
  p1.doctors.all()
  ```

* 1번 의사의 환자 목록

  > `Doctor` 는 직접 참조가 아니라 `Patient` 모델의 역참조.
  >
  > 즉, 기본 naming convention에 따라 참조

  ```python
  d1.patient_set.all()      
  ```

  * `related_name` : 역참조 옵션

    * 기본 값은 `{model 이름}_set` ex) patient_set
    * 직접 바꾸기 위해서는 `related_name` 이용 ex) patients

    ```python
    class Doctor(models.Model):
        name = models.TextField()
    
    class Patient(models.Model):
        name = models.TextField()
        # 역참조 설정. related_name
        doctors = models.ManyToManyField(Doctor, 
                            through='Reservation',
                            related_name='patients')
    
    class Reservation(models.Model):
        doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
        patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    ```

  - 단, 날짜나 간호사 등 컴럼이 더 필요해지면 중개 모델이 반드시 사용해야한다.

#### 중개 모델 사용 X

* 별도의 클래스(`Reservation`) 을 만들어서 할 필요없이 `models.ManyToManyField`를 통해 구현 가능하다.

  ```python
  # 중개모델없이 구현
  class Doctor(models.Model):
      name = models.TextField()
  
  class Patient(models.Model):
      name = models.TextField()
      # 역참조 설정. related_name
      doctors = models.ManyToManyField(Doctor, 
                          through='Reservation',
                          related_name='patients')
  ```

- 예약 만들기

  ```python
  d1 = Doctor.objects.create(name='dr.a')
  p1 = Patient.objects.create(name='a')
  d1.patients.add(p1)
  ```

- 예약 조회하기

  ```python
  d1.patients.all()
  
  p1.doctors.all()
  ```

- 예약 취소하기

  ```python
  d1.patients.remove(p1)
  ```

### 좋아요 기능 구현하기

#### 모델링 - models.py

- related_name 필수

  user.article_set하면 글을 가져올지 좋아요수를 가져올지 모르기 때문

```python
class Article(models.Model):
    title = ...
    content = ...
    created_at = ...
    updated_at = ...
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    like_users = models.ManyToManyField(settings.AUTH_USER_MODEL, related_name='like_articles')    
```

#### url - view - template 흐름

- url - variable routing
- view - 좋아요 누르면 취소, 누리지않으면 좋아요 뜨도록
- template - redirect

##### urls.py

```python 
# urlpatterns 에 추가
path('<int:pk>/like/', views.like, name='like'),
...
```

##### views.py

```python
# solution 1

def like(request, pk):
    article = get_object_or_404(Article, pk=pk)
    # 좋아요 누른적이 있다면 (DB에 저장되있으면)
    if request.user in article.like_users.all():
        # 취소
        article.like_users.remove(request.user)
    # 그게 아니면
    else:
        # 생성 - 좋아요
        article.like_users.add(request.user)
    return redirect('articles:detail', article.pk)
```

```python
# solution 2

def like(request, pk):
    article = get_object_or_404(Article, pk=pk)
    # 좋아요 누른적이 있다면 (DB에 저장되있으면)
    if article.like_users.filter(id=request.user_id).exits():
        # 취소
        article.like_users.remove(request.user)
    # 그게 아니면
    else:
        # 생성 - 좋아요
        article.like_users.add(request.user)
    return redirect('articles:detail', article.pk)
```

##### html

```html
<!-- 좋아요 버튼 만들기 -->
...
{% if request.user in article.like_users.all %}
	<a href="{% url 'articles:like' article.pk %}">좋아요 취소</a>
{% else %}
	<a href="{% url 'articles:like' article.pk %}">좋아요</a>
{% endif %}	
<p>{{ article.like_users.count }}명이 좋아합니다.</p>
...
```

#### 좋아요 아이콘으로 만들기

`FontAwesome`

- CDN 을  base.html에 추가

- 원하는 이미지 copy.html 하여 좋아요 -> 아이콘으로 수정하기

```html
{% if request.user in article.like_users.all %}
	<a href="{% url 'articles:like' article.pk %}">
        <i class="fas fa_heart fa-lg" style="color:red;"></i>
    </a>
{% else %}
	<a href="{% url 'articles:like' article.pk %}">
        <i class="far fa_heart fa-lg" style="color:gray;"></i>
    </a>
{% endif %}	
<p>{{ article.like_users.count }}명이 좋아합니다.</p>
```

##### `animate.css`

- CDN 을  base.html에 추가
- 원하는 애니메니션 효과 추가









